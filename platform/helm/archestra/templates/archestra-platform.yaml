{{/*
Validation: Ensure postgresql.enabled=false when using external database
*/}}
{{- if and .Values.postgresql.external_database_url .Values.postgresql.enabled }}
{{- fail "Configuration error: When postgresql.external_database_url is set, you must also set postgresql.enabled=false to prevent deploying an unused PostgreSQL instance." }}
{{- end }}
{{- if .Values.archestra.blueGreen.enabled }}
{{- if not (or (eq .Values.archestra.blueGreen.active "blue") (eq .Values.archestra.blueGreen.active "green")) }}
{{- fail "Configuration error: archestra.blueGreen.active must be either 'blue' or 'green'." }}
{{- end }}
{{- $activeSlotConfig := index .Values.archestra.blueGreen .Values.archestra.blueGreen.active }}
{{- if not $activeSlotConfig.enabled }}
{{- fail (printf "Configuration error: The active slot '%s' must be enabled (archestra.blueGreen.%s.enabled must be true)." .Values.archestra.blueGreen.active .Values.archestra.blueGreen.active) }}
{{- end }}
{{- end }}
---
apiVersion: v1
kind: Service
metadata:
  name: {{ include "archestra-platform.fullname" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "archestra-platform.labels" . | nindent 4 }}
  {{- with .Values.archestra.service.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  type: {{ .Values.archestra.service.type | default "ClusterIP" }}
  ports:
    - port: 9000
      targetPort: backend
      protocol: TCP
      name: backend
      {{- if and (eq (.Values.archestra.service.type | default "ClusterIP") "NodePort") .Values.archestra.service.nodePorts.backend }}
      nodePort: {{ .Values.archestra.service.nodePorts.backend }}
      {{- end }}
    - port: 9050
      targetPort: metrics
      protocol: TCP
      name: metrics
      {{- if and (eq (.Values.archestra.service.type | default "ClusterIP") "NodePort") .Values.archestra.service.nodePorts.metrics }}
      nodePort: {{ .Values.archestra.service.nodePorts.metrics }}
      {{- end }}
    - port: 3000
      targetPort: frontend
      protocol: TCP
      name: frontend
      {{- if and (eq (.Values.archestra.service.type | default "ClusterIP") "NodePort") .Values.archestra.service.nodePorts.frontend }}
      nodePort: {{ .Values.archestra.service.nodePorts.frontend }}
      {{- end }}
  selector:
    {{- include "archestra-platform.selectorLabels" . | nindent 4 }}
    {{- if .Values.archestra.blueGreen.enabled }}
    archestra.io/slot: {{ .Values.archestra.blueGreen.active }}
    {{- end }}
{{- if .Values.archestra.blueGreen.enabled }}
{{/*
Blue-Green mode: render a Deployment for each enabled slot
*/}}
{{- range $slot := list "blue" "green" }}
{{- $slotConfig := index $.Values.archestra.blueGreen $slot }}
{{- if $slotConfig.enabled }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "archestra-platform.fullname" $ }}-{{ $slot }}
  namespace: {{ $.Release.Namespace }}
  labels:
    {{- include "archestra-platform.labels" $ | nindent 4 }}
    archestra.io/slot: {{ $slot }}
spec:
  {{- if not $.Values.archestra.horizontalPodAutoscaler.enabled }}
  replicas: {{ include "archestra-platform.blueGreen.replicaCount" (dict "root" $ "slot" $slot) }}
  {{- end }}
  {{- with $.Values.archestra.minReadySeconds }}
  minReadySeconds: {{ . }}
  {{- end }}
  selector:
    matchLabels:
      {{- include "archestra-platform.selectorLabels" $ | nindent 6 }}
      archestra.io/slot: {{ $slot }}
  {{- with $.Values.archestra.deploymentStrategy }}
  strategy:
    {{- toYaml . | nindent 4 }}
  {{- end }}
  template:
    metadata:
      labels:
        {{- include "archestra-platform.labels" $ | nindent 8 }}
        archestra.io/slot: {{ $slot }}
      {{- with $.Values.archestra.podAnnotations }}
      annotations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
    spec:
      serviceAccountName: {{ include "archestra-platform.serviceAccountName" $ }}
      {{- with $.Values.archestra.terminationGracePeriodSeconds }}
      terminationGracePeriodSeconds: {{ . }}
      {{- end }}
      initContainers:
        - name: wait-for-postgres
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              echo "Waiting for PostgreSQL to be ready..."
              until nc -z {{ include "archestra-platform.postgresql.host" $ }} {{ include "archestra-platform.postgresql.port" $ }}; do
                echo "PostgreSQL is unavailable - sleeping"
                sleep 1
              done
              echo "PostgreSQL is up - continuing"
      containers:
        - name: {{ $.Chart.Name }}
          image: {{ include "archestra-platform.blueGreen.image" (dict "root" $ "slot" $slot) }}
          imagePullPolicy: {{ $.Values.archestra.imagePullPolicy | default "IfNotPresent" }}
          ports:
            - name: backend
              containerPort: 9000
              protocol: TCP
            - name: metrics
              containerPort: 9050
              protocol: TCP
            - name: frontend
              containerPort: 3000
              protocol: TCP
          env:
            {{- include "archestra-platform.env" $ | nindent 12 }}
          {{- with $.Values.archestra.envFrom }}
          envFrom:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with $.Values.archestra.resources }}
          resources:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          startupProbe:
            httpGet:
              path: /health
              port: backend
            initialDelaySeconds: 5
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 30
          livenessProbe:
            httpGet:
              path: /health
              port: backend
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /ready
              port: backend
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          {{- with $.Values.archestra.lifecycle }}
          lifecycle:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- if and $.Values.archestra.orchestrator.kubernetes.kubeconfig.enabled $.Values.archestra.orchestrator.kubernetes.kubeconfig.secretName }}
          volumeMounts:
            - name: kubeconfig
              mountPath: {{ $.Values.archestra.orchestrator.kubernetes.kubeconfig.mountPath }}
              readOnly: true
          {{- end }}
      {{- with $.Values.archestra.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- if and $.Values.archestra.orchestrator.kubernetes.kubeconfig.enabled $.Values.archestra.orchestrator.kubernetes.kubeconfig.secretName }}
      volumes:
        - name: kubeconfig
          secret:
            secretName: {{ $.Values.archestra.orchestrator.kubernetes.kubeconfig.secretName }}
      {{- end }}
{{- end }}
{{- end }}
{{- else }}
{{/*
Standard mode: single Deployment with rolling update strategy
*/}}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "archestra-platform.fullname" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "archestra-platform.labels" . | nindent 4 }}
spec:
  {{- if not .Values.archestra.horizontalPodAutoscaler.enabled }}
  replicas: {{ .Values.archestra.replicaCount }}
  {{- end }}
  {{- with .Values.archestra.minReadySeconds }}
  minReadySeconds: {{ . }}
  {{- end }}
  selector:
    matchLabels:
      {{- include "archestra-platform.selectorLabels" . | nindent 6 }}
  {{- with .Values.archestra.deploymentStrategy }}
  strategy:
    {{- toYaml . | nindent 4 }}
  {{- end }}
  template:
    metadata:
      labels:
        {{- include "archestra-platform.labels" . | nindent 8 }}
      {{- with .Values.archestra.podAnnotations }}
      annotations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
    spec:
      serviceAccountName: {{ include "archestra-platform.serviceAccountName" . }}
      {{- with .Values.archestra.terminationGracePeriodSeconds }}
      terminationGracePeriodSeconds: {{ . }}
      {{- end }}
      # Init container to wait for PostgreSQL to be ready before starting the application
      # This prevents the application from crashing when PostgreSQL is still starting up
      # and the application tries to run database migrations (in which it assumes that the database is already ready)
      initContainers:
        - name: wait-for-postgres
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              echo "Waiting for PostgreSQL to be ready..."
              until nc -z {{ include "archestra-platform.postgresql.host" . }} {{ include "archestra-platform.postgresql.port" . }}; do
                echo "PostgreSQL is unavailable - sleeping"
                sleep 1
              done
              echo "PostgreSQL is up - continuing"
      containers:
        - name: {{ .Chart.Name }}
          image: {{ include "archestra-platform.image" . }}
          imagePullPolicy: {{ .Values.archestra.imagePullPolicy | default "IfNotPresent" }}
          ports:
            - name: backend
              containerPort: 9000
              protocol: TCP
            - name: metrics
              containerPort: 9050
              protocol: TCP
            - name: frontend
              containerPort: 3000
              protocol: TCP
          env:
            {{- include "archestra-platform.env" . | nindent 12 }}
          {{- with .Values.archestra.envFrom }}
          envFrom:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with .Values.archestra.resources }}
          resources:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          # Startup probe - gives the application time to start up
          # Checks every 10 seconds for up to 5 minutes (30 failures * 10s)
          startupProbe:
            httpGet:
              path: /health
              port: backend
            initialDelaySeconds: 5
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 30
          # Liveness probe - restarts the container if it becomes unresponsive
          livenessProbe:
            httpGet:
              path: /health
              port: backend
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          # Readiness probe - marks the container as ready to receive traffic
          # Uses /ready endpoint which checks database connectivity
          readinessProbe:
            httpGet:
              path: /ready
              port: backend
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          {{- with .Values.archestra.lifecycle }}
          lifecycle:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- if and .Values.archestra.orchestrator.kubernetes.kubeconfig.enabled .Values.archestra.orchestrator.kubernetes.kubeconfig.secretName }}
          volumeMounts:
            - name: kubeconfig
              mountPath: {{ .Values.archestra.orchestrator.kubernetes.kubeconfig.mountPath }}
              readOnly: true
          {{- end }}
      {{- with .Values.archestra.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- if and .Values.archestra.orchestrator.kubernetes.kubeconfig.enabled .Values.archestra.orchestrator.kubernetes.kubeconfig.secretName }}
      volumes:
        - name: kubeconfig
          secret:
            secretName: {{ .Values.archestra.orchestrator.kubernetes.kubeconfig.secretName }}
      {{- end }}
{{- end }}
